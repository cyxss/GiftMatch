<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>无后端随机匹配（不匹配自己）</title>
  <style>
    :root{
      --primary:#4CAF50;
      --primary-dark:#45a049;
      --error:#FF5733;
      --accent:#007BFF;
    }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      margin:0; background:#f9f9f9; color:#333;
      display:flex; min-height:100vh; align-items:center; justify-content:center;
      padding:24px;
    }
    .container{
      width:min(900px,100%);
      background:#fff; padding:24px; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    h1{ color:var(--primary); margin:0 0 8px; font-size:24px;}
    p  { margin:8px 0 16px; color:#555;}
    textarea{
      width:100%; min-height:180px; resize:vertical;
      padding:12px; font-size:15px; line-height:1.6;
      border:1px solid #ddd; border-radius:8px; outline:none;
    }
    textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,123,255,.12);}
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0;}
    button{
      border:0; border-radius:8px; padding:10px 14px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:600;
      transition:transform .05s ease, background .2s;
    }
    button:hover{ background:var(--primary-dark); }
    button:active{ transform:translateY(1px);}
    .secondary{ background:#eee; color:#333; }
    .secondary:hover{ background:#e2e2e2; }
    .ghost{ background:#fff; color:var(--accent); border:1px solid #cfe3ff;}
    .ghost:hover{ background:#f6f9ff; }
    .error{ color:var(--error); font-weight:600; }
    .success{ color:var(--accent); font-weight:600;}
    .grid{
      margin-top:16px; border:1px solid #eee; border-radius:10px; overflow:hidden;
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px 10px; border-bottom:1px solid #f1f1f1; text-align:left; }
    th{ background:#fafafa; font-weight:700; }
    tr:last-child td{ border-bottom:0; }
    .tools{ display:flex; gap:10px; flex-wrap:wrap; }
    .hint{ font-size:13px; color:#777; }
  </style>
</head>
<body>
  <div class="container">
    <h1>随机匹配（Secret Santa / 不匹配自己）</h1>
    <p>把参与者名字逐行粘贴到下面（例如：<code>张三</code> 回车 <code>李四</code> 回车 …）。点击“生成匹配”即可。</p>

    <textarea id="namesInput" placeholder="每行一个名字，例如：&#10;wg&#10;sp&#10;cj&#10;yx&#10;yf&#10;xg"></textarea>

    <div class="row">
      <button id="btnGenerate">生成匹配</button>
      <button id="btnReshuffle" class="secondary">重新随机</button>
      <div class="tools">
        <button id="btnCopy" class="ghost">复制结果</button>
        <button id="btnDownload" class="ghost">下载 CSV</button>
      </div>
    </div>

    <p id="msg" class="hint"></p>

    <div id="tableWrap" class="grid" style="display:none;">
      <table>
        <thead>
          <tr><th>#</th><th>送礼人</th><th>抽到</th></tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // --------- 核心：生成“错排”（无固定点的随机排列） ----------
    // 采用 Sattolo 算法：生成一个单循环排列，天然无“自己匹配自己”的情况。
    function sattoloShuffle(arr) {
      // arr 会被原地打乱为一个大循环（n>1 时无固定点）
      for (let i = arr.length - 1; i > 0; i--) {
        // 与 Fisher-Yates 不同：j ∈ [0, i-1]，保证单循环且无固定点
        const j = Math.floor(Math.random() * i); // 0..i-1
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // 从文本框读取、清洗名字
    function readNames() {
      const raw = document.getElementById('namesInput').value;
      const names = raw
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);

      // 去重（保留出现顺序）
      const seen = new Set();
      const unique = [];
      for (const n of names) {
        if (!seen.has(n)) { seen.add(n); unique.push(n); }
      }
      return unique;
    }

    // 生成一组不匹配自己的配对（送礼人 -> 被抽中）
    function makeDerangementPairs(names){
      if (names.length < 2) {
        throw new Error("至少需要 2 个不同的名字。");
      }
      if (names.length === 2 && names[0] === names[1]) {
        throw new Error("需要两个不同的名字。");
      }

      const givers = names.slice();
      const receivers = names.slice();

      // 当 n=1 无解；n>=2 用 Sattolo 产生无固定点排列
      if (receivers.length === 1) throw new Error("只有 1 个人时无法错排。");

      sattoloShuffle(receivers);

      // 理论上 Sattolo 对 n>1 不会有 giver[i]===receiver[i] 的情况；
      // 但出于安全起见，这里再断言一次（万一未来改造算法）。
      for (let i=0;i<givers.length;i++){
        if (givers[i] === receivers[i]) {
          // 极小概率 fallback：简单交换相邻
          const k = (i+1) % receivers.length;
          [receivers[i], receivers[k]] = [receivers[k], receivers[i]];
        }
      }

      return givers.map((g,i)=>({giver:g, receiver:receivers[i]}));
    }

    // 渲染表格
    function renderTable(pairs){
      const tbody = document.getElementById('resultBody');
      tbody.innerHTML = '';
      pairs.forEach((p,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(p.giver)}</td>
          <td>${escapeHtml(p.receiver)}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('tableWrap').style.display = 'block';
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // 复制到剪贴板
    async function copyPairs(pairs){
      const lines = pairs.map(p=>`${p.giver} -> ${p.receiver}`).join('\n');
      await navigator.clipboard.writeText(lines);
    }

    // 下载 CSV
    function downloadCSV(pairs){
      const header = 'giver,receiver\n';
      const body = pairs.map(p=>`${csvEscape(p.giver)},${csvEscape(p.receiver)}`).join('\n');
      const csv = header + body;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pairings.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function csvEscape(s){
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    // 事件绑定与状态
    let latestPairs = [];

    const $msg = document.getElementById('msg');
    const $btnGenerate = document.getElementById('btnGenerate');
    const $btnReshuffle = document.getElementById('btnReshuffle');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnDownload = document.getElementById('btnDownload');

    function showError(text){ $msg.className='error'; $msg.textContent=text; }
    function showHint(text){ $msg.className='hint'; $msg.textContent=text; }
    function showSuccess(text){ $msg.className='success'; $msg.textContent=text; }

    function tryGenerate(){
      try{
        const names = readNames();
        if (names.length < 2) throw new Error('请输入至少 2 个不同的名字（每行一个）。');
        latestPairs = makeDerangementPairs(names);
        renderTable(latestPairs);
        showSuccess(`已生成 ${latestPairs.length} 对随机匹配（保证无人匹配自己）。`);
      }catch(err){
        latestPairs = [];
        document.getElementById('tableWrap').style.display='none';
        showError(err.message || '生成失败，请检查名单。');
      }
    }

    $btnGenerate.addEventListener('click', tryGenerate);
    $btnReshuffle.addEventListener('click', ()=>{
      if (!document.getElementById('tableWrap').style.display || document.getElementById('tableWrap').style.display==='none'){
        tryGenerate();
        return;
      }
      // 使用同一批名字重新随机
      try{
        const names = readNames();
        latestPairs = makeDerangementPairs(names);
        renderTable(latestPairs);
        showSuccess('已重新随机生成配对结果。');
      }catch(err){
        showError(err.message || '重新随机失败。');
      }
    });

    $btnCopy.addEventListener('click', async ()=>{
      if (!latestPairs.length){ showHint('请先生成匹配结果。'); return; }
      try{ await copyPairs(latestPairs); showSuccess('已复制到剪贴板！'); }
      catch{ showError('复制失败，可能是浏览器限制。'); }
    });

    $btnDownload.addEventListener('click', ()=>{
      if (!latestPairs.length){ showHint('请先生成匹配结果。'); return; }
      downloadCSV(latestPairs);
    });

    // 小提示
    showHint('提示：同名会自动去重；最少需要 2 个名字。');
  </script>
</body>
</html>
