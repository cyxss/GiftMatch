<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>固定种子随机配对（仅本人可查）</title>
  <style>
    :root{ --brand:#4F46E5; --ok:#059669; --err:#DC2626; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Arial,Helvetica,sans-serif; background:#f6f7fb; color:#1f2937; }
    .wrap{ max-width:880px; margin:32px auto; padding:24px; background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    h1{ margin:0 0 10px; font-size:22px; color:var(--brand); }
    p{ margin:8px 0; color:#4b5563; }
    code{ background:#f0f2f7; padding:2px 6px; border-radius:6px; }
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:10px; margin-top:16px; }
    input[type="text"]{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:15px; outline:none; }
    input[type="text"]:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(79,70,229,.12); }
    button{ border:0; background:var(--brand); color:#fff; font-weight:700; padding:12px 16px; border-radius:10px; cursor:pointer; }
    button.secondary{ background:#eef2ff; color:#3730a3; }
    button.ghost{ background:#fff; color:#4f46e5; border:1px solid #c7d2fe; }
    .hint{ font-size:13px; color:#6b7280; }
    .msg{ margin-top:14px; font-weight:700; }
    .msg.ok{ color:var(--ok); }
    .msg.err{ color:var(--err); }
    details{ margin-top:18px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ padding:10px; border-bottom:1px solid #f0f2f7; text-align:left; }
    th{ background:#fbfbfe; }
    .note{ font-size:13px; color:#6b7280; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>固定种子随机配对（不匹配自己）</h1>

    <hr style="border:none;border-top:1px solid #eee; margin:14px 0 8px;" />

    <div>
      <label for="nameInput" class="hint">在下方输入你的名字（需是sp, wg, cj, yx, yf, xg中的一个，大小写不敏感）</label>
      <div class="grid">
        <input id="nameInput" type="text" placeholder="例如：CJ" />
        <button id="btnLookup">查看我的配对</button>
      </div>
      <p id="msg" class="msg hint"></p>
    </div>


  </div>

  <script>
    // ===================== 可配置区 =====================
    // 预先设置的 6 个人名（大小写不敏感；展示时保留原样）。
    // 👉 在正式使用前，把下面数组替换为你的 6 个名字（必须互不相同）。
    const NAMES = [
      'SP',
      'WG',
      'CJ',
      'YX',
      'YF',
      'XG'
    ];

    // 固定随机种子（保持不变即可保证全平台一致）。可以写任何字符串。
    const SEED_STR = '2025-09-22-Seed-v1';
    // =================== 配置区结束 =====================

    // ---- 工具：大小写不敏感匹配 ----
    const lowerSet = new Map(NAMES.map(n => [n.toLowerCase(), n]));

    // ---- 种子随机：xmur3 + mulberry32 ----
    // xmur3 产生一个 32-bit 散列并返回种子生成器
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i=0; i<str.length; i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function(){
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
      }
    }
    // mulberry32：简单快速的 32 位 PRNG
    function mulberry32(a){
      return function(){
        let t = (a += 0x6D2B79F5) >>> 0;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    // 给定字符串种子 -> 生成 [0,1) 随机数函数
    function seededRNG(seedStr){
      const seedGen = xmur3(seedStr);
      // 组合几个种子值以减少碰撞
      const a = seedGen();
      const b = seedGen();
      const c = seedGen();
      const d = seedGen();
      // 合成一个新整数种子（也可只用 a）
      const mix = (a ^ (b<<5)) ^ (c>>>3) ^ d;
      return mulberry32(mix >>> 0);
    }

    // ---- Sattolo 单循环打乱（保证无固定点）----
    function sattoloShuffleSeeded(array, rng){
      // 原地打乱，生成单圈置换：对于 n>1，不会出现 fixed point
      for (let i = array.length - 1; i > 0; i--){
        // 关键：j ∈ [0, i-1]
        const j = Math.floor(rng() * i); // 0..i-1
        const tmp = array[i];
        array[i] = array[j];
        array[j] = tmp;
      }
      return array;
    }

    // ---- 生成固定映射（送礼人 -> 被抽中）----
    function buildPairs(names, seedStr){
      if (names.length !== 6) throw new Error('必须恰好 6 个人。');
      // 基本校验：唯一性
      const uniq = new Set(names.map(n => n.toLowerCase()));
      if (uniq.size !== names.length) throw new Error('名字必须互不相同。');

      const givers = names.slice();
      const receivers = names.slice();
      const rng = seededRNG(seedStr);
      if (receivers.length < 2) throw new Error('人数不足以错排。');
      sattoloShuffleSeeded(receivers, rng);

      // 安全断言：不应出现固定点
      for (let i=0;i<givers.length;i++){
        if (givers[i] === receivers[i]){
          // 理论上不会触发；如触发，做一次相邻交换
          const k = (i+1) % receivers.length;
          const t = receivers[i]; receivers[i]=receivers[k]; receivers[k]=t;
        }
      }
      // 输出映射
      const map = new Map();
      for (let i=0;i<givers.length;i++) map.set(givers[i], receivers[i]);
      return map;
    }

    // 计算一次全局固定映射（跨设备一致）
    const PAIR_MAP = buildPairs(NAMES, SEED_STR);

    // ---- UI：个人查询 ----
    const $input = document.getElementById('nameInput');
    const $btn = document.getElementById('btnLookup');
    const $msg = document.getElementById('msg');

    function showMsg(text, cls){
      $msg.className = 'msg ' + (cls||'');
      $msg.textContent = text;
    }

    function onLookup(){
      const raw = ($input.value || '').trim();
      if (!raw){ showMsg('请输入你的名字。','err'); return; }
      const keyLower = raw.toLowerCase();
      if (!lowerSet.has(keyLower)){
        showMsg('未在名单中找到该名字，请与组织者确认书写是否一致。','err');
        return;
      }
      const canonical = lowerSet.get(keyLower); // 原样展示
      const target = PAIR_MAP.get(canonical);
      if (!target){
        showMsg('内部错误：未找到配对。','err');
        return;
      }
      showMsg(`你抽到的人是：${target}`,'ok');
    }

    $btn.addEventListener('click', onLookup);
    $input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') onLookup(); });

    // ---- 验证/展示工具（开发用）----
    const $reveal = document.getElementById('btnReveal');
    const $pairsBody = document.getElementById('pairsBody');
    const $tableWrap = document.getElementById('tableWrap');

    $reveal.addEventListener('click', ()=>{
      $pairsBody.innerHTML = '';
      let i=0;
      for (const giver of NAMES){
        const tr = document.createElement('tr');
        const rec = PAIR_MAP.get(giver);
        tr.innerHTML = `<td>${++i}</td><td>${escapeHtml(giver)}</td><td>${escapeHtml(rec)}</td>`;
        $pairsBody.appendChild(tr);
      }
      $tableWrap.style.display = 'block';
    });

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
  </script>
</body>
</html>